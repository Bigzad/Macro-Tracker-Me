<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Macro Calculator - Login</title>
    
    <!-- Console Log Capture for Debugging -->
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Simple Logger - Must load first to control logging -->

    
    <!-- Initialization Manager - Must load after simple logger -->
    <!-- Unified Supabase Auth System -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="auth-manager.js"></script>

<script src="initialization-manager.js"></script>
    
    <!-- Supabase Authentication System -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
    


    

<!-- COMPREHENSIVE ERROR HANDLING FOR AUTHENTICATION -->
<script src="error-handling-system.js"></script>
<script src="safe-json-handler.js"></script>
<script src="enhanced-database-functions.js"></script>
    
    <!-- Security Middleware - Protects API endpoints -->
    <script src="security-middleware.js"></script>
    
    <!-- Subscription Management System -->
    <script src="subscription-manager.js"></script>
    <script src="subscription-middleware.js"></script>

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Enhanced Auth Widget Configuration */
        .auth-widget {
            --color-primary: #667eea;
            --color-primary-dark: #764ba2;
        }

        /* Auth widget container styles */
        .auth-widget-container {
            min-height: 450px !important;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* Try to force name field display in various ways */
        .auth-modal-content form {
            display: block !important;
        }

        .auth-modal-content input[name="name"],
        .auth-modal-content input[type="text"]:first-of-type {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            width: 100% !important;
        }

        /* Force show any hidden name-related fields */
        .auth-modal-content .auth-field:has(input[name="name"]) {
            display: block !important;
        }

        /* Override any hiding styles */
        .auth-modal-content [style*="display: none"] input[name="name"] {
            display: block !important;
        }
        
        /* Custom Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 320px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-left: 4px solid #047857;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-left: 4px solid #b45309;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-left: 4px solid #b91c1c;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-left: 4px solid #1d4ed8;
        }
        
        .notification-icon {
            font-size: 20px;
            margin-right: 12px;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        /* Supabase Auth Modal Styling */
        #supabase-auth-modal .auth-modal-content {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        /* Ensure auth modal appears with proper styling */
        #supabase-auth-modal {
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* Mobile Responsive Fixes */
        * {
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        /* Notification responsive fixes */
        .notification {
            left: 10px;
            right: 10px;
            width: auto;
            min-width: auto;
            max-width: calc(100vw - 20px);
            transform: translateX(0);
            opacity: 0;
            visibility: hidden;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700">
        <div class="max-w-md w-full mx-4">
            <!-- Logo/Brand Section -->
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-white bg-opacity-20 rounded-full mb-4">
                    <i class="fas fa-calculator text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">AI-Powered Macro Calculator</h1>
                <p class="text-blue-100 text-lg">Personalized nutrition planning made simple</p>
            </div>
            
            <!-- Access Card -->
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="text-center mb-6">
                    <div class="inline-block p-3 bg-purple-100 rounded-full mb-4">
                        <i class="fas fa-lock text-2xl text-purple-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Member Access Required</h2>
                    <p class="text-gray-600">This application is invite-only. Please log in with your invited account to continue.</p>
                </div>
                
                <!-- Login Button -->
                <button  class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center justify-center gap-3">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In to Continue</span>
                </button>
                
                <!-- Forgot Password Link -->
                <div class="text-center mt-4">
                    <a href="password-reset.html" class="text-purple-600 hover:text-purple-800 text-sm font-medium transition-colors inline-flex items-center gap-2">
                        <i class="fas fa-key text-xs"></i>
                        Forgot your password?
                    </a>
                </div>
                
                <!-- Alternative Access Section -->
                <div class="mt-6 space-y-4">
                    <!-- Invite Code Option -->
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                        <div class="flex items-start gap-3 mb-3">
                            <i class="fas fa-ticket-alt text-green-500 mt-1"></i>
                            <div>
                                <h3 class="font-semibold text-green-800 mb-1">Have an Invite Code?</h3>
                                <p class="text-green-700 text-sm">Use your invite code to create an account instantly.</p>
                            </div>
                        </div>
                        <button onclick="showInviteCodeModal()" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class="fas fa-key mr-2"></i>
                            Enter Invite Code
                        </button>
                    </div>
                    
                    <!-- Email Invitation Info -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                            <div>
                                <h3 class="font-semibold text-blue-800 mb-1">Need Access?</h3>
                                <p class="text-blue-700 text-sm">This app uses invite-only registration. Contact your administrator to request an invitation or invite code.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Features Preview -->
                <div class="mt-6">
                    <h3 class="font-semibold text-gray-700 mb-3 text-center">What's Inside</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-calculator text-purple-500"></i>
                            <span>Macro Calculator</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-chart-line text-purple-500"></i>
                            <span>Progress Tracking</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-utensils text-purple-500"></i>
                            <span>Meal Planning</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-600">
                            <i class="fas fa-book-open text-purple-500"></i>
                            <span>Recipe Database</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6 text-blue-100 text-sm">
                <p>Secure â€¢ Private â€¢ Invite-Only</p>
            </div>
        </div>
    </div>

    

    <!-- Unified Auth Script -->
    
    <script>
      // Define startAnimations function for page initialization
      function startAnimations() {
        console.log("Starting page animations and visual effects...");
        
        // Fade in main content
        const mainContent = document.querySelector('main, .hero-section, #main-content');
        if (mainContent) {
          mainContent.style.opacity = '0';
          mainContent.style.transition = 'opacity 0.6s ease-in-out';
          setTimeout(() => {
            mainContent.style.opacity = '1';
          }, 100);
        }
        
        // Animate feature cards with stagger effect
        const featureCards = document.querySelectorAll('.feature-card, .bg-white.rounded-lg, .p-6');
        featureCards.forEach((card, index) => {
          if (card) {
            card.style.transform = 'translateY(20px)';
            card.style.opacity = '0';
            card.style.transition = 'all 0.6s ease-out';
            setTimeout(() => {
              card.style.transform = 'translateY(0)';
              card.style.opacity = '1';
            }, 200 + (index * 100));
          }
        });
        
        // Animate buttons with hover effects
        const buttons = document.querySelectorAll('.btn, button, .bg-blue-600, .bg-green-600');
        buttons.forEach(button => {
          if (button) {
            button.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
            button.addEventListener('mouseenter', () => {
              button.style.transform = 'translateY(-2px)';
              button.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            });
            button.addEventListener('mouseleave', () => {
              button.style.transform = 'translateY(0)';
              button.style.boxShadow = '';
            });
          }
        });
        
        console.log("âœ… Page animations initialized");
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, starting unified auth...");

        // Always start your CSS animations or other app logic
        if (typeof startAnimations === "function") {
          console.log("Running animations...");
          startAnimations();
        }

        // Check for Supabase invite/confirmation link
        if (window.location.hash && (window.location.hash.includes("access_token") || window.location.hash.includes("confirmation_token"))) {
          console.log("Auth link detected:", window.location.hash);
          
          // Check if this is an invitation link - parse from HASH not search params
          const urlParams = new URLSearchParams(window.location.search);
          const hashParams = new URLSearchParams(window.location.hash.substring(1)); // Remove # and parse
          const isInvitationLink = urlParams.get('type') === 'invite' || hashParams.get('type') === 'invite';
          
          console.log("ðŸ” DEBUG: URL params type:", urlParams.get('type'));
          console.log("ðŸ” DEBUG: Hash params type:", hashParams.get('type'));
          console.log("Is invitation link:", isInvitationLink);

          // Clean the URL to prevent breaking scripts
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState(null, "", cleanUrl);

          // Wait a moment to ensure Supabase Auth is loaded
          setTimeout(() => {
            if (window.authWrapper) {
              if (isInvitationLink) {
                console.log("Opening Supabase Auth signup for invitation...");
                window.authWrapper.open("signup");
              } else {
                console.log("Opening Supabase Auth login...");
                window.authWrapper.open("login");
              }

              // Handle login success
              window.authWrapper.on("login", () => {
                console.log("Login successful, redirecting...");
                document.location.href = "app.html"; // change if you want another page
              });
            } else {
              console.error("Supabase Auth wrapper not found.");
            }
          }, 500);
        } else {
          console.log("Normal site load, no invite token.");
        }
      });
    </script>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center md:text-left">
                <div>
                    <h3 class="text-lg font-semibold mb-2">Macro Calculator</h3>
                    <p class="text-gray-300 text-sm">Your AI-powered nutrition tracking companion.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">Legal</h3>
                    <ul class="space-y-1 text-sm">
                        <li><a href="disclaimer.html" class="text-blue-400 hover:text-blue-300 transition-colors">
                            <i class="fas fa-exclamation-triangle mr-1"></i>Disclaimer
                        </a></li>
                        <li><a href="privacy-policy.html" class="text-blue-400 hover:text-blue-300 transition-colors">
                            <i class="fas fa-shield-alt mr-1"></i>Privacy Policy
                        </a></li>
                        <li><a href="terms-of-service.html" class="text-blue-400 hover:text-blue-300 transition-colors">
                            <i class="fas fa-file-contract mr-1"></i>Terms of Service
                        </a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">For Professionals</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="coach-login.html" class="text-green-400 hover:text-green-300 transition-colors inline-flex items-center">
                            <i class="fas fa-dumbbell mr-2"></i>Coach Portal
                        </a></li>
                        <li><p class="text-gray-300">Are you a nutrition coach or trainer? Access your coaching dashboard.</p></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-6 pt-6 text-center text-sm text-gray-400">
                <p>&copy; 2024 Macro Calculator. All rights reserved.</p>
            </div>
        </div>
    </footer>
<!-- Consent Notice Popup - Legal Compliance (Add to index.html) -->
<div id="consent-popup" class="consent-popup-overlay hidden">
    <div class="consent-popup-container">
        <div class="consent-popup-content">
            <!-- Header -->
            <div class="consent-header">
                <h2 class="consent-title">
                    <i class="fas fa-shield-alt"></i>
                    Legal Notice & Consent
                </h2>
            </div>
            
            <!-- Content -->
            <div class="consent-body">
                <p class="consent-text">
                    By using our AI-Powered Macro Calculator, you acknowledge that you have read and agree to our legal documents:
                </p>
                
                <div class="consent-links">
                    <a href="disclaimer.html" target="_blank" class="consent-link">
                        <i class="fas fa-exclamation-triangle"></i> Disclaimer
                    </a>
                    <a href="privacy-policy.html" target="_blank" class="consent-link">
                        <i class="fas fa-shield-alt"></i> Privacy Policy
                    </a>
                    <a href="terms-of-service.html" target="_blank" class="consent-link">
                        <i class="fas fa-file-contract"></i> Terms of Service
                    </a>
                </div>
                
                <p class="consent-notice">
                    <strong>Important:</strong> This app is for educational purposes only and does not provide medical advice. By continuing, you consent to our data processing practices and agree to use the app at your own risk.
                </p>
            </div>
            
            <!-- Footer with Both Buttons -->
            <div class="consent-footer">
                <div class="consent-buttons">
                    <button id="consent-decline" class="consent-decline-btn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                    <button id="consent-accept" class="consent-accept-btn">
                        <i class="fas fa-check"></i>
                        Accept & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Consent Popup Styles - Clean & Mobile-Friendly */
.consent-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    z-index: 999999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.3s ease-out;
}

/* Hide popup when not needed */
.consent-popup-overlay.hidden {
    display: none;
}

/* Main container */
.consent-popup-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease-out;
}

/* Content wrapper */
.consent-popup-content {
    padding: 0;
}

/* Header section */
.consent-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 16px 16px 0 0;
}

.consent-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Body section */
.consent-body {
    padding: 24px;
}

.consent-text {
    margin: 0 0 20px 0;
    color: #374151;
    font-size: 1rem;
    line-height: 1.6;
}

/* Legal document links */
.consent-links {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 20px 0;
    padding: 16px;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.consent-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    color: #3b82f6;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.2s;
    font-weight: 500;
}

.consent-link:hover {
    background: #dbeafe;
    color: #1d4ed8;
    transform: translateX(4px);
}

/* Important notice */
.consent-notice {
    margin: 20px 0 0 0;
    padding: 16px;
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    color: #92400e;
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Footer section */
.consent-footer {
    padding: 24px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    border-radius: 0 0 16px 16px;
}

/* Button container */
.consent-buttons {
    display: flex;
    gap: 12px;
    flex-direction: column;
}

/* Decline button */
.consent-decline-btn {
    width: 100%;
    padding: 14px 24px;
    background: #f3f4f6;
    color: #6b7280;
    border: 2px solid #d1d5db;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.consent-decline-btn:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
    color: #374151;
    transform: translateY(-1px);
}

.consent-decline-btn:active {
    transform: translateY(0);
}

/* Accept button */
.consent-accept-btn {
    width: 100%;
    padding: 14px 24px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.consent-accept-btn:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
}

.consent-accept-btn:active {
    transform: translateY(0);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .consent-popup-overlay {
        padding: 10px;
    }
    
    .consent-header {
        padding: 20px;
    }
    
    .consent-title {
        font-size: 1.3rem;
    }
    
    .consent-body {
        padding: 20px;
    }
    
    .consent-footer {
        padding: 20px;
    }
    
    .consent-links {
        padding: 12px;
    }
    
    .consent-link {
        padding: 10px;
        font-size: 0.9rem;
    }
}

/* Larger screens - horizontal button layout */
@media (min-width: 480px) {
    .consent-buttons {
        flex-direction: row;
    }
    
    .consent-decline-btn,
    .consent-accept-btn {
        flex: 1;
    }
}

/* Extra small screens */
@media (max-width: 480px) {
    .consent-popup-container {
        margin: 0;
        border-radius: 12px;
    }
    
    .consent-header {
        border-radius: 12px 12px 0 0;
    }
    
    .consent-footer {
        border-radius: 0 0 12px 12px;
    }
}
</style>

<script>
// Consent Popup JavaScript - Legal Compliance Handler
document.addEventListener('DOMContentLoaded', function() {
    
    // Configuration
    const CONSENT_KEY = 'macro_calculator_consent_accepted';
    const CONSENT_VERSION = '1.0';
    
    // DOM Elements
    const consentPopup = document.getElementById('consent-popup');
    const acceptButton = document.getElementById('consent-accept');
    const declineButton = document.getElementById('consent-decline');
    
    // Check if consent has already been given
    function hasUserConsented() {
        const storedConsent = localStorage.getItem(CONSENT_KEY);
        return storedConsent === CONSENT_VERSION;
    }
    
    // Show the consent popup
    function showConsentPopup() {
        if (consentPopup) {
            consentPopup.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            console.log('Consent popup displayed - first visit detected');
        }
    }
    
    // Hide the consent popup
    function hideConsentPopup() {
        if (consentPopup) {
            consentPopup.classList.add('hidden');
            document.body.style.overflow = '';
            console.log('Consent popup hidden');
        }
    }
    
    // Store user consent in localStorage
    function storeConsent() {
        localStorage.setItem(CONSENT_KEY, CONSENT_VERSION);
        localStorage.setItem(CONSENT_KEY + '_timestamp', Date.now());
        console.log('User consent stored - popup will not show again');
    }
    
    // Handle accept button click
    function handleAcceptConsent() {
        storeConsent();
        hideConsentPopup();
        console.log('Legal consent accepted - app fully initialized');
    }
    
    // Handle decline button click
    function handleDeclineConsent() {
        console.log('User declined consent - redirecting to access denied page');
        window.location.href = 'access-denied.html';
    }
    
    // Initialize consent system
    function initializeConsentSystem() {
        // Check if user has already consented
        if (hasUserConsented()) {
            console.log('User has previously consented - popup skipped');
            return;
        }
        
        // Show popup for first-time visitors
        showConsentPopup();
        
        // Attach event listeners to both buttons
        if (acceptButton) {
            acceptButton.addEventListener('click', handleAcceptConsent);
        }
        
        if (declineButton) {
            declineButton.addEventListener('click', handleDeclineConsent);
        }
        
        // Prevent closing popup by clicking outside
        if (consentPopup) {
            consentPopup.addEventListener('click', function(event) {
                if (event.target === consentPopup) {
                    event.preventDefault();
                    const container = consentPopup.querySelector('.consent-popup-container');
                    container.style.animation = 'none';
                    setTimeout(() => {
                        container.style.animation = 'slideUp 0.3s ease-out';
                    }, 10);
                }
            });
        }
    }
    
    // Start the consent system
    initializeConsentSystem();
    
    // Public API for manual consent management
    window.ConsentManager = {
        hasConsent: hasUserConsented,
        clearConsent: function() {
            localStorage.removeItem(CONSENT_KEY);
            localStorage.removeItem(CONSENT_KEY + '_timestamp');
            console.log('Consent cleared - popup will show on next visit');
        },
        showPopup: showConsentPopup,
        hidePopup: hideConsentPopup,
        simulateDecline: handleDeclineConsent
    };
});
</script>


  <script src="supabase-config.js"></script>
  <script src="auth-manager.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await authWrapper.init();
      authWrapper.redirectIfAuthed('app.html');
      authWrapper.on('login', () => location.href = 'app.html');
      authWrapper.on('logout', () => location.href = 'index.html');
    });
  </script>

<!-- Login Modal (Frosted Glass, Responsive) -->
<div id="login-modal" class="login-modal-overlay">
  <div class="login-modal-content">
    <h2>Sign In</h2>
    <p id="login-error" class="login-error"></p>
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button id="login-submit">Login</button>
    <button id="login-cancel" class="cancel">Cancel</button>
  </div>
</div>

<style>
  /* Overlay */
  .login-modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.2s ease-in-out;
  }

  /* Modal content */
  .login-modal-content {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .login-modal-content h2 {
    margin: 0 0 8px;
    font-size: 1.5rem;
    text-align: center;
  }

  .login-modal-content input {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }

  .login-modal-content button {
    border: none;
    border-radius: 8px;
    padding: 10px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s ease-in-out;
  }

  #login-submit {
    background-color: #3F5B48;
    color: white;
  }

  #login-submit:hover {
    background-color: #2f4637;
  }

  #login-cancel {
    background-color: transparent;
    color: #555;
  }

  #login-cancel:hover {
    color: #000;
  }

  .login-error {
    color: #d9534f;
    font-size: 0.9rem;
    text-align: center;
    min-height: 20px;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @media (max-width: 480px) {
    .login-modal-content {
      width: 95%;
      padding: 20px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('login-modal');
    const openBtn = document.querySelector('#sign-in-btn');
    const cancelBtn = document.getElementById('login-cancel');
    const submitBtn = document.getElementById('login-submit');
    const emailField = document.getElementById('login-email');
    const passField = document.getElementById('login-password');
    const errorEl = document.getElementById('login-error');

    function openModal() {
      modal.style.display = 'flex';
      emailField.focus();
    }

    function closeModal() {
      modal.style.display = 'none';
      errorEl.textContent = '';
      emailField.value = '';
      passField.value = '';
    }

    if (openBtn) openBtn.addEventListener('click', openModal);
    cancelBtn.addEventListener('click', closeModal);

    window.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    async function handleLogin() {
      const email = emailField.value.trim();
      const password = passField.value.trim();
      if (!email || !password) {
        errorEl.textContent = "Please enter both email and password.";
        return;
      }
      try {
        const { error } = await authWrapper.signIn(email, password);
        if (error) {
          errorEl.textContent = error.message || "Invalid credentials.";
          if (typeof showNotification === 'function')
            showNotification("Login Failed", error.message, "error");
        } else {
          if (typeof showNotification === 'function')
            showNotification("Login Successful", "Redirecting...", "success");
          setTimeout(() => location.href = 'app.html', 800);
        }
      } catch (err) {
        console.error("Login error:", err);
        errorEl.textContent = "An unexpected error occurred.";
      }
    }

    submitBtn.addEventListener('click', handleLogin);
    passField.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Remove any legacy inline onclick handlers that call handleAuth
    document.querySelectorAll('[onclick*="handleAuth"]').forEach(el => el.removeAttribute('onclick'));

    const modal = document.getElementById('login-modal');
    const openBtn = document.getElementById('sign-in-btn') || document.querySelector('button[onclick*="handleAuth"]');
    const cancelBtn = document.getElementById('login-cancel');
    const submitBtn = document.getElementById('login-submit');
    const emailField = document.getElementById('login-email');
    const passField = document.getElementById('login-password');
    const errorEl = document.getElementById('login-error');

    function openModal() {
      if (!modal) return;
      modal.style.display = 'flex';
      setTimeout(() => emailField && emailField.focus(), 0);
    }
    function closeModal() {
      if (!modal) return;
      modal.style.display = 'none';
      if (errorEl) errorEl.textContent = '';
      if (emailField) emailField.value = '';
      if (passField) passField.value = '';
    }

    if (openBtn) openBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    async function handleLogin() {
      const email = (emailField && emailField.value || '').trim();
      const password = (passField && passField.value || '').trim();
      if (!email || !password) {
        if (errorEl) errorEl.textContent = "Please enter both email and password.";
        return;
      }
      try {
        const { error } = await authWrapper.signIn(email, password);
        if (error) {
          if (errorEl) errorEl.textContent = error.message || "Invalid credentials.";
          if (typeof showNotification === 'function') showNotification("Login Failed", error.message || "Invalid credentials.", "error");
        } else {
          if (typeof showNotification === 'function') showNotification("Login Successful", "Redirecting...", "success");
          setTimeout(() => location.href = 'app.html', 600);
        }
      } catch (err) {
        console.error("Login error:", err);
        if (errorEl) errorEl.textContent = "An unexpected error occurred.";
      }
    }

    if (submitBtn) submitBtn.addEventListener('click', handleLogin);
    if (passField) passField.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
  });
</script>

</body>
</html>